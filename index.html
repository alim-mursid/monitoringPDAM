<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monitoring Air PDAM Multi Pengguna</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      push,
      set,
      get,
      query,
      orderByChild,
      limitToLast,
    } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAorkSRFuT1CwZtXMpJaEvmjW51a3LAse8",
      authDomain: "monitoringairpdam-bd78d.firebaseapp.com",
      databaseURL:
        "https://monitoringairpdam-bd78d-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "monitoringairpdam-bd78d",
      storageBucket: "monitoringairpdam-bd78d.appspot.com",
      messagingSenderId: "1050691156280",
      appId: "1:1050691156280:web:8c5bc1da03e15dc69069cd",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const userSelect = document.getElementById("userSelect");
    const debitElem = document.getElementById("debit");
    const totalElem = document.getElementById("total");
    const estimasiElem = document.getElementById("estimasi");
    const batasLiterElem = document.getElementById("batasLiter");
    const statusAlertElem = document.getElementById("statusAlert");
    const riwayatBody = document.getElementById("riwayat-body");
    const saveBatasBtn = document.getElementById("saveBatas");
    const exportExcelBtn = document.getElementById("exportExcel");
    const clearHistoryBtn = document.getElementById("clearHistory");

    let selectedUser = "esp1";
    let lastTotal = 0;

    function formatRupiah(value) {
      return new Intl.NumberFormat("id-ID", {
        style: "currency",
        currency: "IDR",
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      }).format(value);
    }

    function formatDateTime(dateString) {
      const date = new Date(dateString);
      const formattedDate = date.toLocaleDateString("id-ID", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
      });
      const formattedTime = date.toLocaleTimeString("id-ID", {
        hour: "2-digit",
        minute: "2-digit",
        hour12: false,
      });
      return `${formattedDate} ${formattedTime}`;
    }

    function loadData(user) {
      const monitoringRef = ref(db, `/${user}/monitoring`);
      onValue(monitoringRef, (snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          debitElem.innerText = data.debit.toFixed(2) + " L/m";
          totalElem.innerText = data.total.toFixed(2) + " L";

          const hargaPerLiter = 1550 / 1000;
          const estimasiHarga = data.total * hargaPerLiter;
          estimasiElem.innerText = formatRupiah(estimasiHarga);

          lastTotal = data.total;

          const batasLiterRef = ref(db, `/${user}/settings/batasLiter`);
          get(batasLiterRef).then((snap) => {
            if (snap.exists()) {
              batasLiterElem.value = snap.val();
              if (lastTotal > snap.val()) {
                statusAlertElem.innerText =
                  "PERINGATAN: Total liter melebihi batas!";
                statusAlertElem.classList.remove("bg-green-100", "text-green-600");
                statusAlertElem.classList.add("bg-red-100", "text-red-600");
              } else {
                statusAlertElem.innerText = "Status: Normal";
                statusAlertElem.classList.remove("bg-red-100", "text-red-600");
                statusAlertElem.classList.add("bg-green-100", "text-green-600");
              }
            }
          });
        }
      });

      const riwayatRef = query(
        ref(db, `/${user}/riwayat`),
        orderByChild("waktu"),
        limitToLast(50)
      );
      onValue(riwayatRef, (snapshot) => {
        riwayatBody.innerHTML = "";
        if (snapshot.exists()) {
          const data = snapshot.val();
          const entries = Object.values(data).sort(
            (a, b) => new Date(a.waktu) - new Date(b.waktu)
          );
          entries.forEach((entry) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td class="border px-3 py-1">${formatDateTime(entry.waktu)}</td>
              <td class="border px-3 py-1">${entry.debit.toFixed(2)}</td>
              <td class="border px-3 py-1">${entry.total.toFixed(2)}</td>
              <td class="border px-3 py-1">${formatRupiah(entry.biaya)}</td>
            `;
            riwayatBody.appendChild(row);
          });
        }
      });
    }

    function saveBatasLiter() {
      const val = parseFloat(batasLiterElem.value);
      if (isNaN(val) || val < 0) {
        alert("Mohon masukkan nilai batas liter yang valid (angka positif)");
        return;
      }
      set(ref(db, `/${selectedUser}/settings/batasLiter`), val)
        .then(() => alert("Batas liter berhasil disimpan"))
        .catch((err) => alert("Gagal simpan batas liter: " + err.message));
    }

    function exportToExcel() {
      let rows = [["Waktu", "Debit (L/m)", "Total (L)", "Biaya (Rp)"]];
      riwayatBody.querySelectorAll("tr").forEach((tr) => {
        const cells = tr.querySelectorAll("td");
        let waktuCell = cells[0].innerText;

        // Format ulang waktu ke DD/MM/YYYY HH:mm
        let dateObj = new Date(waktuCell);
        let formattedDate = dateObj.toLocaleDateString("id-ID", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
        });
        let formattedTime = dateObj.toLocaleTimeString("id-ID", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        });
        let formattedDateTime = `${formattedDate} ${formattedTime}`;

        let row = [formattedDateTime];
        for (let i = 1; i < cells.length; i++) {
          row.push(cells[i].innerText);
        }
        rows.push(row);
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, "Riwayat");

      XLSX.writeFile(
        wb,
        `Riwayat_${selectedUser}_${new Date().toISOString()}.xlsx`
      );
    }

    async function clearHistory() {
      if (
        confirm("Apakah Anda yakin ingin menghapus semua riwayat pengguna ini?")
      ) {
        try {
          await set(ref(db, `/${selectedUser}/riwayat`), null);
          riwayatBody.innerHTML = "";
          alert("Riwayat berhasil dihapus");
        } catch (err) {
          alert("Gagal hapus riwayat: " + err.message);
        }
      }
    }

    userSelect.addEventListener("change", () => {
      selectedUser = userSelect.value;
      loadData(selectedUser);
    });

    saveBatasBtn.addEventListener("click", saveBatasLiter);
    exportExcelBtn.addEventListener("click", exportToExcel);
    clearHistoryBtn.addEventListener("click", clearHistory);

    loadData(selectedUser);
  </script>
</head>
<body class="bg-gray-100 p-6 max-w-4xl mx-auto font-sans">
  <h1 class="text-3xl font-bold mb-6 text-center text-blue-700">
    Monitoring Air PDAM Multi Pengguna
  </h1>

  <div class="mb-4 flex items-center gap-4">
    <label for="userSelect" class="font-semibold">Pilih Pengguna:</label>
    <select id="userSelect" class="border rounded p-2">
      <option value="esp1">Pengguna 1 (ESP1)</option>
      <option value="esp2">Pengguna 2 (ESP2)</option>
    </select>
  </div>

  <div class="grid grid-cols-3 gap-4 mb-6 text-center">
    <div class="p-4 bg-white rounded shadow">
      <p class="font-semibold text-gray-700">Debit Air Saat Ini</p>
      <p id="debit" class="text-2xl font-bold text-blue-600">0 L/m</p>
    </div>
    <div class="p-4 bg-white rounded shadow">
      <p class="font-semibold text-gray-700">Total Air Digunakan</p>
      <p id="total" class="text-2xl font-bold text-green-600">0 L</p>
    </div>
    <div class="p-4 bg-white rounded shadow">
      <p class="font-semibold text-gray-700">Estimasi Biaya</p>
      <p id="estimasi" class="text-2xl font-bold text-yellow-600">Rp 0</p>
    </div>
  </div>

  <div
    id="statusAlert"
    class="mb-6 p-3 rounded text-center font-semibold bg-green-100 text-green-600"
  >
    Status: Normal
  </div>

  <div class="mb-6 p-4 bg-white rounded shadow">
    <h2 class="font-semibold mb-3">Pengaturan Batas Liter (L)</h2>
    <input
      type="number"
      id="batasLiter"
      class="border rounded p-2 w-32 mr-4"
      min="0"
      step="0.1"
      placeholder="Masukkan batas liter"
    />
    <button
      id="saveBatas"
      class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
    >
      Simpan Batas
    </button>
  </div>

  <div class="mb-6">
    <h2 class="font-semibold mb-2">Riwayat Penggunaan (50 terakhir)</h2>
    <div class="overflow-x-auto border rounded shadow">
      <table class="min-w-full border-collapse">
        <thead class="bg-blue-600 text-white">
          <tr>
            <th class="px-3 py-1 border">Waktu</th>
            <th class="px-3 py-1 border">Debit (L/m)</th>
            <th class="px-3 py-1 border">Total (L)</th>
            <th class="px-3 py-1 border">Biaya (Rp)</th>
          </tr>
        </thead>
        <tbody id="riwayat-body"></tbody>
      </table>
    </div>
  </div>

  <div class="flex gap-4 mb-10">
    <button
      id="exportExcel"
      class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex-1"
    >
      Ekspor ke Excel
    </button>
    <button
      id="clearHistory"
      class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 flex-1"
    >
      Hapus Semua Riwayat
    </button>
  </div>

  <footer class="text-center text-gray-500 text-sm">
    &copy; 2025 Monitoring Air PDAM Multi Pengguna
  </footer>
</body>
</html>
